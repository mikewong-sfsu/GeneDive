/**
 @class		TwoHopTest
 @brief		Test the two hop for gene and report errors
 @details
 @authors	Mike Wong mikewong@sfsu.edu, Nayana Laxmeshwar nlaxmeshwar@mail.sfsu.edu
 @ingroup	tests
*/

const Test    = require( '../tests/Test' );
const Table   = require( '../ui-automation/view/Table' );
const Graph   = require( '../ui-automation/view/Graph' );
const mixwith = require( 'mixwith' );
const mix     = mixwith.mix;

class TwoHop extends mix( Test ).with( Table, Graph ) {
	get name(){ return "TwoHop"; }

	execute() {
	    return new Promise( async ( resolve, reject ) => {
			try {
				let dgrs = [ 'SFTPA1', 'SFTPA2' ];

				// ===== TEST THE MECHANICS OF SEARCHING
				await this.login();
				await this.twoHop();
				await this.search( dgrs );

				// ===== TEST THE RESULTS
				let results = await this.resultsTable();
				let regex   = new RegExp( dgrs.join( '|' ));

				// Test that every row in the table contains the search DGR
				let valid   = results.reduce(( valid, row ) => { return valid && (row.DGR1.match( regex ) || row.DGR2.match( regex )); }, true );
				if( ! valid ) { reject( `Some rows do not have search DGR "${dgrs[0]} or "${dgrs[1]}""` ); }

				// Test that every node in the graph contains a DGR described in the table
				let table   = new Set();
				results.forEach(( row ) => { table.add( row.DGR1 ); table.add( row.DGR2 ); });

				let graph   = new Set( await this.graphNodes());
				let diff    = new Set([ ... table ].filter( x => ! graph.has( x )));
				if( diff.length ) { reject( `${diff.length} DGRs found in query results that are not shown in the graph` ); }

				resolve( this.result( true, "Successfully searched using two-hop topology mode" ));
			} catch( e ) {
				reject( e );
			}
		});
	}
}

module.exports = TwoHop
