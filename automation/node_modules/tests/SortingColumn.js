
/**
 @class		SortingColumn
 @brief		Test to check if rows are filtered according to DGR. 
 @details
 @authors	Vaishali Bisht vbisht1@mail.sfsu.edu
 @ingroup	tests
*/

const Test    = require('./Test');
const Table   = require( '../ui-automation/view/Table' );
const mixwith = require( 'mixwith' );
const mix     = mixwith.mix;

/**
 @class		SortingColumn
 @brief		Checks table column sorting
 @details   Ensures that GeneDive properly deploys the jQuery TableSorter
			plugin for the GeneDive results table. For details, see
            https://mottie.github.io/tablesorter/docs/
 @authors	Mike Wong mikewong@sfsu.edu, Nayana Laxmeshwar nlaxmeshwar@mail.sfsu.edu
 @ingroup	tests
*/
class SortingColumn extends mix( Test ).with( Table ) {
	get name() { return 'SortingColumn'; }

	execute() {
		return new Promise( async ( resolve, reject ) => {
			let dgr   = 'SFTPA1'; // MW NEED TO PARAMETERIZE THIS LATER

			await this.login();
			await this.oneHop();
			await this.search( dgr );

			let headers  = await this.page.$$eval( '.header', headers => headers.map( header => header.id ));
			let hasClass = async ( id, c ) => { return await this.page.evaluate(( id, c ) => { return $( `#${id}` ).hasClass( c ); }, id, c ); };
			let getField = async ( id )    => { return await this.page.evaluate(( id )    => { return $( `#${id}` ).text() }, id ); };

			for( let order of [ 'SortUp', 'SortDown' ]) {
				for( let id of headers ) {

					// Keep clicking the header to get to the requested ordering
					for( let clicks = 0; clicks < 3 && ! await hasClass( id, `header${order}`); clicks++ ) {
						await this.click( `#${id}` );
					}
					if( ! await hasClass( id, `header${order}` )) { reject( `Sorting Order ${order} for column ${id} not achieved after 3 clicks` ); }
					await this.page.waitFor( 500 ); // Let TableSorter do some work first.
					console.log( `Checking ${id} for ${order}`, 'SortUp', await hasClass( id, 'headerSortUp' ), 'SortDown', await hasClass( id, 'headerSortDown' ) ); // MW
					let numeric = await hasClass( id, 'numeric' );
					let summary = await this.table.summary();
					let field   = await getField( id );
					let sorted  = summary.map( x => numeric ? parseFloat( x[ field ]) : x[ field ].toLowerCase() );

					// Confirm that the rows are sorted appropriately
					console.log( sorted );
					let isSorted = false;
					if( order == 'SortUp' )   { isSorted = sorted.every(( val, i, arr ) => i == 0 || (val <= arr[ i - 1 ])); } else 
					if( order == 'SortDown' ) { isSorted = sorted.every(( val, i, arr ) => i == 0 || (val >= arr[ i - 1 ])); }

					if( ! isSorted ) { reject( `Column ${field} is improperly sorted for '${order}'` ); }
				}
			}
			resolve( 'TableSorter is correctly deployed in the GeneDive Results Table' );
		});
	}
}


module.exports = SortingColumn;
