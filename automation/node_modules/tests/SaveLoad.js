/**
 * @class   SaveLoadTest
 * @brief   Test the one hop for gene and report errors
 * @details
 * @authors Mike Wong mikewong@sfsu.edu, Nayana Laxmeshwar nlaxmeshwar@mail.sfsu.edu
 * @ingroup tests
*/

const fs              = require( 'fs' );
const os              = require( 'os' );
const Test            = require( '../tests/Test' );
const Table           = require( '../ui-automation/view/Table' );
const Graph           = require( '../ui-automation/view/Graph' );
const ConfidenceScore = require( '../ui-automation/ConfidenceScore' );
const Filter          = require( '../ui-automation/Filter' );
const SaveLoad        = require( '../ui-automation/SaveLoad' );
const mixwith         = require( 'mixwith' );
const mix             = mixwith.mix;

class SaveLoadTest extends mix( Test ).with( SaveLoad, ConfidenceScore, Filter, Table, Graph ) {
	get name() { return "Save and Load"; }

	execute(){
		return new Promise( async ( resolve, reject ) => {
			try {
				await this.login();
				await this.oneHop();
				await this.search( 'fentanyl' );
				await this.confidence.score.high();
				await this.filter.excerpt.is( 'opioid' );
				await this.graph.redraw();

				// Get the results and download the session file
				let results  = JSON.stringify( await this.table.summary());
				let filename = await this.save( 'Fentanyl effect on opioids' );
				let download = `${os.homedir()}/Downloads/${filename}`;
				if( ! fs.existsSync( download )) { reject( `Download failed: "${download}" not found` ); }

				// Logout and log back in
				await this.logout();
				await this.login();

				// Upload the session file and compare states
				await this.load( download );
				let compare  = JSON.stringify( await this.table.summary());
				if( results != compare ) { reject( 'State restored from upload different from original state prior to download' ); }

				fs.unlinkSync( download );

				resolve( this.result( true, "Save and Upload features work as tested" ));

			} catch( e ) {
				reject( e );
			}
		});
	}
}

module.exports = SaveLoadTest;
