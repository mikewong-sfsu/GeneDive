
/**
 * @class   PubmedLink
 * @brief   Test to check if Pubmed link is working and report errors. 
 * @details
 * @authors Mike Wong mikewong@sfsu.edu, Vaishali Bisht vbisht1@mail.sfsu.edu
 * @ingroup tests
*/

const Test    = require( '../tests/Test' );
const Table   = require( '../ui-automation/view/Table' );
const mixwith = require( 'mixwith' );
const mix     = mixwith.mix;

class PubmedLink extends mix( Test ).with( Table ) {
	get name() { return "PubmedLink"; }
	execute() {
		return new Promise(async (resolve, reject) => {
			try {
				let dgrs = [ 'SP-A', 'Tino' ];

				await this.login();
				await this.oneHop();
				await this.search( dgrs );

				let results = await this.table.summary();
				for( let group of results ) {
					await this.click( `#${group.selector}` );
					await this.pageToLoad();

					let rowids = await this.page.$$eval( '.table tbody tr', group => group.map( tr => $( tr ).attr( 'id' )));

					for( let id of rowids ) {
						let selector = `#${id} .pubmedLink .fa-link`;
						await this.page.waitForSelector( selector );
						await this.click( selector );
						// await this.page.evaluate(( selector ) => { $( selector ).click(); }, selector ); // MW Workaround; selector doesn't seem to work for Puppeteer click()
						await this.pageToLoad();

						const pages = await this.browser.pages();
						let   page  = pages.find( page => page.url().match( /www\.ncbi\.nlm\.nih\.gov\/pubmed/ ));
						if( ! page ) { reject( 'Pubmed link did not resolve' ); }

						page.close();
					}

					await this.click( '.go-back' );

					resolve( "Pubmed Links all work as tested" );
				}

			} catch ( e ) {
				reject( e );
			}
		});
	}
}

module.exports = PubmedLink;
