
/**
 * @class   PubmedLink
 * @brief   Test to check if Pubmed link is working and report errors. 
 * @details
 * @authors Mike Wong mikewong@sfsu.edu, Vaishali Bisht vbisht1@mail.sfsu.edu
 * @ingroup tests
*/

const Test    = require( '../tests/Test' );
const Table   = require( '../ui-automation/view/Table' );
const mixwith = require( 'mixwith' );
const mix     = mixwith.mix;

class PubmedLink extends mix( Test ).with( Table ) {
	get name() { return "PubmedLink"; }
	execute() {
		return new Promise(async (resolve, reject) => {
			try {
				let dgrs = [ 'SP-A', 'Tino' ];

				await this.login();
				await this.oneHop();
				await this.search( dgrs );

				let results = await this.table.summary();
				for( let row of results ) {
					await this.click( `#${row.selector}` );
					await this.pageToLoad();

					let urls = this.page.$$eval( '.pubmedLink', a => $( a ).attr( 'href' ));

					for( let url of urls ) {
						let pm = url.match( /pubmedID=(?<id>\d+)/ );
						await this.click( `.pubmedLink[href="${url}"]` );
						await this.pageToLoad();

						let   pmid  = new RegExp( pm.id );
						const pages = await this.browser.pages();
						if( ! pages.some( page => page.url().match( pmid ))) {
							reject( 'Pubmed link did not resolve' );
						}
					}
				}

			} catch ( e ) {
				reject( e );
			}
		});
	}
}

module.exports = PubmedLink;
